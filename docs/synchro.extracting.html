---

title: synchro.extracting


keywords: fastai
sidebar: home_sidebar

summary: "Function to extract data of an experiment from 3rd party programs"
description: "Function to extract data of an experiment from 3rd party programs"
nb_path: "11_synchro.extracting.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 11_synchro.extracting.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To align timeseries of an experiment, we need to read logs and import data produced by 3rd party softwares used during the experiment. It includes:</p>
<ul>
<li>QDSpy logging</li>
<li>Numpy arrays of the stimuli</li>
<li>SpykingCircus spike sorting refined with Phy</li>
<li>Eye tracking results from MaskRCNN</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_QDSpy_logs" class="doc_header"><code>get_QDSpy_logs</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_QDSpy_logs</code>(<strong><code>log_dir</code></strong>)</p>
</blockquote>
<p>Factory function to generate QDSpy_log objects from all the QDSpy logs of the folder <code>log_dir</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="QDSpy_log" class="doc_header"><code>class</code> <code>QDSpy_log</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L24" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>QDSpy_log</code>(<strong><code>log_path</code></strong>)</p>
</blockquote>
<p>Class defining a QDSpy log.
It reads the log it represent and extract the stimuli information from it:</p>
<ul>
<li>Start and end time</li>
<li>Parameters like the md5 key</li>
<li>Frame delays</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Stimulus" class="doc_header"><code>class</code> <code>Stimulus</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L108" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Stimulus</code>(<strong><code>start</code></strong>)</p>
</blockquote>
<p>Stimulus object containing information about it's presentation.</p>
<ul>
<li>start_time : a datetime object)</li>
<li>stop_time : a datetime object)</li>
<li>parameters : Parameters extracted from the QDSpy</li>
<li>md5 : The md5 hash of that compiled version of the stimulus</li>
<li>name : The name of the stimulus</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To read QDSpy logs of your experiment, simply provide the folder containing the log you want to read to <a href="/theonerig/synchro.extracting.html#get_QDSpy_logs"><code>get_QDSpy_logs</code></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It returns a list fo the QDSpy logs. Stimuli are contained in a list inside each log:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The stimuli objects contains informations on how their display went:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># print(stim.name, stim.start_time, stim.frame_delay, stim.md5)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some stimuli are generated shortly before every display. <code>[`get_synced_file`](/theonerig/synchro.nested_stims.html#get_synced_file)</code> matches the compiled stimuli from a directory of your choice to the stimulus (<code>stim_id</code>) you are looking at, based on timestamps.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_synced_file" class="doc_header"><code>get_synced_file</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L145" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_synced_file</code>(<strong><code>stim_list_dir</code></strong>, <strong><code>stim_id</code></strong>)</p>
</blockquote>
<p>Find the stimulus in the stimulus list directory that is temporally closest to the stimulus in the log.
Works based on the modification time of the stimulus (i.e. expects stimulus to be compiled shortly
before display).
Input:</p>

<pre><code>- stim_list_dir: fullpath to stimuli, string
- stim_id: stimulus read from QDSpy log, theonerig.synchro.extracting.Stimulus object
</code></pre>
<p>Output:</p>

<pre><code>- stim: filename of the stimulus that needs loading, str</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_stim_npy" class="doc_header"><code>unpack_stim_npy</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L184" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_stim_npy</code>(<strong><code>npy_dir</code></strong>, <strong><code>md5_hash</code></strong>)</p>
</blockquote>
<p>Find the stimuli of a given hash key in the npy stimulus folder. The stimuli are in a compressed version
comprising three files. inten for the stimulus values on the screen, marker for the values of the marker
read by a photodiode to get the stimulus timing during a record, and an optional shader that is used to
specify informations about a shader when used, like for the moving gratings.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To unpack the stimulus values, provide the folder of the numpy arrays and the hash of the stimulus:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Unpacked is a tuple, where the first element is the intensity of shape (n_frames, n_colors, y, x)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The second element of the tuple repesents the marker values for the timing. QDSpy defaults are zero and ones, but I used custom red squares taking intensities [50,100,150,200,250] to time with five different signals</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Each stimulus is also starting with a barcode, of the form:</p>
<p>0 0 0 0 0 0 4 0 4*[1-4] 0 4*[1-4] 0 4*[1-4] 0 4*[1-4] 0 4 0 0 0 0 0 0</p>
<p>and ends with 0 0 0 0 0 0</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_spyking_circus_results" class="doc_header"><code>extract_spyking_circus_results</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L224" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_spyking_circus_results</code>(<strong><code>dir_</code></strong>, <strong><code>record_basename</code></strong>)</p>
</blockquote>
<p>Extract the good cells of a record. Overlap with phy_results_dict.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_best_pupil" class="doc_header"><code>extract_best_pupil</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L242" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_best_pupil</code>(<strong><code>fn</code></strong>)</p>
</blockquote>
<p>From results of MaskRCNN, go over all or None pupil detected and select the best pupil.
Each pupil returned is (x,y,width,height,angle,probability)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="stack_len_extraction" class="doc_header"><code>stack_len_extraction</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L259" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>stack_len_extraction</code>(<strong><code>stack_info_dir</code></strong>)</p>
</blockquote>
<p>Extract from ImageJ macro directives the size of the stacks acquired.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

