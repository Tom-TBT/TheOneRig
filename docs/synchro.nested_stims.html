---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "14_synchro.nested_stims.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 14_synchro.nested_stims.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>synchro.nested_stims</p>
<blockquote><p>Functions to synchronize data from QDSpy stimuli that consist of presenting a sequence
of shorter stimuli. Often those are compiled shortly before their presentation so they
need different handling</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_stim_ids" class="doc_header"><code>get_stim_ids</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/nested_stims.py#L20" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_stim_ids</code>(<strong><code>log</code></strong>, <strong><code>record_time</code></strong>, <strong><code>lastmodif_time</code></strong>)</p>
</blockquote>
<p>Obtain the correct name of the stimulus, based on the name that appears in the QDSpy log</p>
<p>This is needed if no central database of compiled stimuli is used, but instead stimuli are compiled in QDSpy
every time before they are presented.</p>
<p>params:</p>

<pre><code>- log: log object generated by get_QDSpy_logs
- record_time: the stimulus presentation time, as calculated by subtracting stimulus duration from lastmodif_time
- lastmodif_time: the timestamp of the .npy file (time of compilation, assumed to be only seconds before record_time)
</code></pre>
<p>returns:</p>

<pre><code>- stim_ids: Correct stim_id for the stimulus presented after the current log stimulus start</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_synced_file" class="doc_header"><code>get_synced_file</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/extracting.py#L145" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_synced_file</code>(<strong><code>stim_list_dir</code></strong>, <strong><code>stim_id</code></strong>)</p>
</blockquote>
<p>Find the stimulus in the stimulus list directory that is temporally closest to the stimulus in the log.
Works based on the modification time of the stimulus (i.e. expects stimulus to be compiled shortly
before display).
Input:</p>

<pre><code>- stim_list_dir: fullpath to stimuli, string
- stim_id: stimulus read from QDSpy log, theonerig.synchro.extracting.Stimulus object
</code></pre>
<p>Output:</p>

<pre><code>- stim: filename of the stimulus that needs loading, str</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_synced_file_precompile" class="doc_header"><code>get_synced_file_precompile</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/nested_stims.py#L94" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_synced_file_precompile</code>(<strong><code>stim_list_dir</code></strong>, <strong><code>stim_id</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_stim_dict" class="doc_header"><code>get_stim_dict</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/nested_stims.py#L104" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_stim_dict</code>(<strong><code>stim_dict_path</code></strong>, <strong><code>stim_filename</code></strong>)</p>
</blockquote>
<p>Get the correct dictionary file that decodes the ints that encode the stimulus sequence.
Applicable to nested stimuli, whose <em>intensity</em>.npy file contains only a list of integers.</p>
<p>params:</p>

<pre><code>- stim_dict_path: [string], the path to the directory where all dicts are stored
- stim_filename: [string], the name of the stimulus, make sure that stim_id from the QDSpy log and the name of the dictionary match</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cluster_by_list" class="doc_header"><code>cluster_by_list</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/processing.py#L189" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cluster_by_list</code>(<strong><code>data</code></strong>, <strong><code>frame_timepoints</code></strong>, <strong><code>frame_signals</code></strong>, <strong><code>stim_list</code></strong>)</p>
</blockquote>
<p>Assign the stimulus identity values from stim_list to the frames in data. stim_list contains only the
sequence of stimuli. Those need to be expanded. Opposed to cluster_frame_signals and cluster_by_epochs no
AUC operation is performed.
Input:</p>

<pre><code>- data: raw data used to compute the stimulus times
- frame_timepoints: timepoints delimiting each frame
- frame_signals: binary 1-D numpy array indicating if high_threshold was passed in 'detect_frames'
- stim_list: 1-D numpy array containing the sequence of the stimuli presented
</code></pre>
<p>Output:</p>

<pre><code>- frame_signals: [same size as frame_timepoints] stim_signals list containing the correct value from
    stim_list at every entry</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_stim_onsets" class="doc_header"><code>find_stim_onsets</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/nested_stims.py#L151" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_stim_onsets</code>(<strong><code>frame_signals</code></strong>)</p>
</blockquote>
<p>Get the frame timepoints during which the stimuli started and ended.
Crop out the last two ones that are currently just an offset marker.</p>
<p>params:</p>

<pre><code>- frame_signals: processed signal from the Photodiode files, containing the marker information
</code></pre>
<p>returns:</p>

<pre><code>- epoch_end: the frame timepoints of the offset signal
- stim_change: the frame timepoints of every stimulus on and offset</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="append_tread_movement" class="doc_header"><code>append_tread_movement</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/nested_stims.py#L171" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>append_tread_movement</code>(<strong><code>reM</code></strong>, <strong><code>epoch_counter</code></strong>, <strong><code>treadmill_data</code></strong>, <strong><code>ref_timepoints</code></strong>)</p>
</blockquote>
<p>Append treadmill data to the record Master</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Always</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span> <span class="n">the</span> <span class="n">alignment</span> <span class="ow">is</span> <span class="n">correct</span> <span class="n">using</span> <span class="err">```</span><span class="n">find_starting_position</span><span class="o">.</span><span class="n">ipynb</span><span class="err">```</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-cyan-fg">  File </span><span class="ansi-green-fg">&#34;&lt;ipython-input-8-e7cbb7229119&gt;&#34;</span><span class="ansi-cyan-fg">, line </span><span class="ansi-green-fg">2</span>
<span class="ansi-red-fg">    Always make sure that the alignment is correct using ```find_starting_position.ipynb```</span>
           ^
<span class="ansi-red-fg">SyntaxError</span><span class="ansi-red-fg">:</span> invalid syntax
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="append_to_reM" class="doc_header"><code>append_to_reM</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/nested_stims.py#L193" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>append_to_reM</code>(<strong><code>epoch_counter</code></strong>, <strong><code>reM</code></strong>, <strong><code>retain_template</code></strong>, <strong><code>stim_list_dir</code></strong>, <strong><code>stim_ids</code></strong>, <strong><code>record_time</code></strong>, <strong><code>photo_data</code></strong>, <strong><code>stim_code_dict</code></strong>, <strong><code>frame_tp</code></strong>, <strong><code>ref_timepoints</code></strong>, <strong><code>ref_signals</code></strong>, <strong><code>tom_stim_dir</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="master_loop" class="doc_header"><code>master_loop</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/synchro/nested_stims.py#L325" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>master_loop</code>(<strong><code>log</code></strong>, <strong><code>retain_template</code></strong>, <strong><code>tom_stim_dir</code></strong>, <strong><code>sync_dir</code></strong>, <strong><code>calcium_dir</code></strong>, <strong><code>stim_list_dir</code></strong>, <strong><code>stim_dict_dir</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

